# 默认 .config 生成过程

使用命令`make mx6ull_14x14_evk_defconfig V=1`生成默认板级 .config 时，实际执行如下：

```bash
make -f ./scripts/Makefile.build obj=scripts/basic
  cc -Wp,-MD,scripts/basic/.fixdep.d -Wall -Wstrict-prototypes -O2 -fomit-frame-pointer   -std=gnu11       -o scripts/basic/fixdep scripts/basic/fixdep.c   
rm -f .tmp_quiet_recordmcount
make -f ./scripts/Makefile.build obj=scripts/kconfig mx6ull_14x14_evk_defconfig
  cc -Wp,-MD,scripts/kconfig/.conf.o.d -Wall -Wstrict-prototypes -O2 -fomit-frame-pointer   -std=gnu11     -c -o scripts/kconfig/conf.o scripts/kconfig/conf.c
  bison -oscripts/kconfig/zconf.tab.c -t -l scripts/kconfig/zconf.y
  flex -oscripts/kconfig/zconf.lex.c -L scripts/kconfig/zconf.l
  cc -Wp,-MD,scripts/kconfig/.zconf.tab.o.d -Wall -Wstrict-prototypes -O2 -fomit-frame-pointer   -std=gnu11    -Iscripts/kconfig -c -o scripts/kconfig/zconf.tab.o scripts/kconfig/zconf.tab.c
  cc   -o scripts/kconfig/conf scripts/kconfig/conf.o scripts/kconfig/zconf.tab.o   
gcc -E -nostdinc -P -I . -undef -x assembler-with-cpp ./arch/../configs/mx6ull_14x14_evk_defconfig -o generated_defconfig
sed -i -e 's/^[[:space:]]//' generated_defconfig
scripts/kconfig/conf  --defconfig=generated_defconfig Kconfig
```

其中关键部分

```bash
make -f ./scripts/Makefile.build obj=scripts/basic
rm -f .tmp_quiet_recordmcount
make -f ./scripts/Makefile.build obj=scripts/kconfig mx6ull_14x14_evk_defconfig
gcc -E -nostdinc -P -I . -undef -x assembler-with-cpp ./arch/../configs/mx6ull_14x14_evk_defconfig -o generated_defconfig
sed -i -e 's/^[[:space:]]//' generated_defconfig
scripts/kconfig/conf  --defconfig=generated_defconfig Kconfig
```

## 制作conf工具

```bash
make -f ./scripts/Makefile.build obj=scripts/basic
rm -f .tmp_quiet_recordmcount
make -f ./scripts/Makefile.build obj=scripts/kconfig mx6ull_14x14_evk_defconfig
```

*这里会使用 Flex（词法分析器）和 Bison（语法分析器）去生成处理 Kconfig 文件的c语言（主要用zconf.y、zconf.l,生成zconf.tab.c、zconf.lex.c）。*

## 分析generated_defconfig的生成

1. 预处理
    
    ```bash
    gcc -E -nostdinc -P -I . -undef -x assembler-with-cpp     ./arch/../configs/mx6ull_14x14_evk_defconfig -o generated_defconfig
    ```

    - **`-E`**: 只运行预处理器阶段，不进行编译、汇编和链接
    - **`-nostdinc`**: 不搜索标准系统头文件目录
    - **`-P`**: 禁止生成行号信息（#line directives）
    - **`-I .`**: 将当前目录添加到头文件搜索路径
    - **`-undef`**: 不预定义任何系统特定的宏
    - **`-x assembler-with-cpp`**: 将输入文件当作"汇编器带C预处理器"的语言处理（当作要预处理汇编既可以使用预处理，又可以避免严格的C语法检查）

    这个命令巧妙利用了GCC预处理器的强大功能来处理非C语言的配置文件，是Linux内核构建系统中常见的配置处理技术。

2. 删除行首无用空格

    ```bash
    sed -i -e 's/^[[:space:]]//' generated_defconfig
    ```

    匹配行首第一个字符是否为空格，是则删除改空格。

## 分析conf的大体工作

### scripts/kconfig/conf.c

1. 设置conf模式

    从main函数开始关注，使用标准c库函数`getopt_long`获取长参数，对应为`--defconfig`(`--defconfig=generated_defconfig`)

    ![conf_get_long_opts](./img/config生成/conf_get_long_opts.png)

    长参数对应枚举和提示

    ![conf_long_opts](./img/config生成/conf_long_opts.png)

    获取对应枚举后通过`switch ... case`做出相应处理。针对`defconfig`的处理是将参数后面的文件名`generated_defconfig`（字符串）,由库函数的全局变量`optarg`赋值给`defconfig_file`。

    ![defconfig_do](./img/config生成/defconfig_do.png)

    至此，第一个参数获取完成，**conf生成 .config 的模式是以配置文件`generated_defconfig`为基础且其他无关选项为默认值**。

2. 读取Kconfig代码

    根据第一步库函数查到的最后的下标`optind`，获取Kconfig的文件名，也就是第二个参数`Kconfig`（在这里就是根目录下的`Kconfig`）。

    将文件名传入函数`conf_parse`（在生成的 zconf.tab.c 中），使用在制作阶段生成的处理Kconfig文件的c代码，**解析Kconfig文件内容**。

    ![read_Kconfig](./img/config生成/read_Kconfig.png)

3. 读取默认值

    再次根据第一个参数枚举，`defconfig`就会去**解析板级默认配置**（也就是之前根据`mx6ull_14x14_evk_defconfig`预处理后的`generated_defconfig`）。

    猜测具体内容可能有：
    - 根据板级默认配置，设置板级默认配置项
    - 根据板级默认配置项和Kconfig，生成依赖的配置项（如板级设置A=y，而A=y时根据Kconfig的代码会设置B=y）

    ![read_defconfig_file](./img/config生成/read_defconfig_file.png)

4. 设置其他选项

    再次根据第一个参数枚举，调用`conf_set_all_new_symbols`并传入不同参数来**对其他配置项做处理**，`defconfig`传入的参数是`def_default`处理猜测是：对目前还没有设置的配置项（部分在第3步中配置，剩下的就是和板级默认配置项无依赖关系的配置项），根据Kconfig里的默认配置设置。

    ![set_other_default](./img/config生成/set_other_default.png)

5. 写入 .config 

    将所有配置项从程序的数据结构中解析写入 .config。

    ![write_config](./img/config生成/write_config.png)

到这里就生成了.config。

---

*为什么要根据板级默认配置文件来生成 .config，而不是直接保存板级的 .config 呢？这样流程不是更简单易懂。*

- *我理解下来uboot包含了大量的板级配置，如果全保存 .config，难免会导致占用大量空间存放无用配置项（`#CONFIG_XXX is not set`）。*

- *通过板级默认文件生成 .config，可以良好压缩去除无用配置项；同时一些相互依赖的项也可以只保存关键部分（如板级设置A=y，而A=y时根据Kconfig的代码会在生成时设置B=y）。*

